# gokitdemo
A demo for go-kit useage

## How to build and run the services.

In each service folder, for eample in the orders folder, run

    go build -o bin/orders main.go

    go run main.go

Ideally I should use **make** along with docker to simplify the process but I didn't do it because I tbink it is not an imporant factor of this demo.

## Using the services

* There are three services: ```User```, ```Product``` and ```Order```. Where ```Product``` and ```Order``` have their own database.

### User

To generate token for a given email/password, and to validate a given token. Note this project harcodes only one accout for demo purpose. Please use the specified account to test.

There are two endponts:
* **v1/users/auth** to generate token which will be used in ```Order``` service
* **v1/users/valide-token** to validate tokens from the ```Order``` service.

```
curl -X "POST" "http://localhost:8081/v1/users/auth" \
     -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -d $'{
  "email": "fira1026@gmail.com",
  "password": "1234567"
}'

```

The result should be a token, like:

```
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6ImZpcmExMDI2QGdtYWlsLmNvbSIsImV4cCI6MTY4MTM5NjU3OSwiaWF0IjoxNjgxMzkyOTQ5LCJuYmYiOjE2ODEzOTI5NDl9.ojYMU2CDKKhuAj7gnRrz9DxyrofJCCEUfd7PE8thSro"
}
```

### Product

To handle product related request. In the project will only decrease stock quantity once an order created. The ```products``` table schema is:

| column  | type |
| ------------- |:-------------:|
| id      | integer    |
| name      | string     |
| price    | integer     |
| quantity    | integer     |


There is one endpont:
* **v1/products/decrease-quantity** to decrease product stock quantity once ```Order``` creates a new order. Note this endipoint is designed to accept request from ```Order```only. The reponse will contain price and updated quantity of updated product. The price will be used by ```User``` to calculate the total price of an order.


### Order

To be simplified, I let each order contains only one product with quantity, and the ```orders``` table schema is:

| column  | type |
| ------------- |:-------------:|
| id      | integer    |
| email      | string     |
| product_name    | integer     |
| quantity    | integer     |
| total_price    | integer     |

There is one endpont:
* **v1/orders/** to create an order from given product name and quantity.


To create an order, we need to use the token generated by the ```User``` service:

```
curl -X "POST" "http://localhost:8083/v1/orders/" \
     -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
	 -H 'Authorization:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6ImZpcmExMDI2QGdtYWlsLmNvbSIsImV4cCI6MTY4MTM5NjU3OSwiaWF0IjoxNjgxMzkyOTQ5LCJuYmYiOjE2ODEzOTI5NDl9.ojYMU2CDKKhuAj7gnRrz9DxyrofJCCEUfd7PE8thSro' \
     -d $'{
  "product_name": "Apple",
  "quantity": 2
}'
```

The result should be:

```
{"order_id":1,"email":"fira1026@gmail.com","total_price":40}
```

Be aware the product quantity will be decreased accordingly. If there is not enough staock available, the api will return error message.


## Some notes

* go-kit transport supports http and grpc. I started with grpc due to grpc is generally with higher performance but I found it is a bit difficult to implement compared to http, it needs to handle both server side and client side, so finally I use http.
* I put the token validation in the middleware and it is ideally resides under root directory so each service can use it, but I encountered package import issue so I put it under the ```Order``` sercvice.
* I was aware of the product quantity decreement would have race-condition in a real world project. Generally I will use ```SELECT FOR UPDATE``` to prevent it, but sqlite3 doesn't support the feature so I let be as is.
* After token validation the middleware will add user email to the request header. I found out it is not trivial to get the header in the serivice handler. I studied how to resolve it and I did but I am not sure if it is the best practice.
